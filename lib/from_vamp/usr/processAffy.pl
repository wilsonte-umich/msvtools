#!/usr/local/bin/perl

use strict;
use warnings;

#quant-norm.pm-only.brlmm-p.snp-posteriors.txt
##%SnpPosteriorFormatVer=1
##%guid=4b8c882e-1581-4881-ed86-bc143647f074
##%data-order=meanX,varX,nObsMean,nObsVar,meanY,varY,covarXY
#id	BB	AB	AA	CV
#JAX00000001	-1.41455,0.0455882,38.8594,94.89,9.42885,0.0383707,0.00756532	-0.403112,0.0455882,44.1421,58.0962,9.47762,0.0383707,0.00605267	0.546427,0.0455882,26.9984,75.0138,9.53567,0.0383707,-0.000552811	-0.1,-0.1,-0.1,-0.05,-0.1,-0.05,0,0,0,0,0,0
#JAX00000002	-2.13095,0.0408079,34,85,9.66198,0.0331891,0.00154028	-0.360715,0.0408079,42,54,9.90695,0.0331891,0.0080569	1.85802,0.0408079,34,89,9.41899,0.0331891,-0.00176758	-0.1,-0.1,-0.1,-0.05,-0.1,-0.05,0,0,0,0,0,0
#JAX00000003	-1.71399,0.0689335,20,57,9.00197,0.0426278,-0.00827029	-0.0365063,0.0689335,46,61.9976,9.26609,0.0426278,0.00720211	1.44135,0.0689335,44,109.002,9.22035,0.0426278,0.0119663	-0.1,-0.1,-0.1,-0.05,-0.1,-0.05,0,0,0,0,0,0
#JAX00000004	-1.35454,0.0429129,38.999,94.999,10.1886,0.0481686,-0.00569098	-0.123302,0.0429129,44.001,58.001,10.2942,0.0481686,0.00983583	1.26445,0.0429129,27,75,9.83626,0.0481686,-0.000196369	-0.1,-0.1,-0.1,-0.05,-0.1,-0.05,0,0,0,0,0,0
#JAX00000005	-1.71046,0.0598326,25,67,10.1509,0.0452272,-0.00692015	0.0385774,0.0598326,46,62,10.4161,0.0452272,0.0172079	2.17951,0.0598326,39,99,9.7575,0.0452272,0.0159171	-0.1,-0.1,-0.1,-0.05,-0.1,-0.05,0,0,0,0,0,0
#JAX00000006	-2.03832,0.0762464,39,94.9998,8.40694,0.0650641,-0.0290682	0.607065,0.0762464,47,64.0002,9.16955,0.0650641,0.00881808	2.27453,0.0762464,24,69.0001,9.09772,0.0650641,0.0156791	-0.1,-0.1,-0.1,-0.05,-0.1,-0.05,0,0,0,0,0,0
#JAX00000007	-1.94734,0.0737436,39,95,10.119,0.0818745,-0.0215023	0.332629,0.0737436,44.0027,58.0027,10.6986,0.0818745,-0.030194	2.3041,0.0737436,26.9973,74.9973,10.2466,0.0818745,0.0251918	-0.1,-0.1,-0.1,-0.05,-0.1,-0.05,0,0,0,0,0,0

#quant-norm.pm-only.brlmm-p.normalized-summary.txt

##minimal file for normalized values
##%guid=74658ad9-2d5c-46bd-70a1-d7ffa340b423
#probeset_id	datatype	F1cross01.CEL	F1cross02.CEL	F1cross03.CEL	F1cross04.CEL	F1cross05.CEL	F1cross06.CEL	F1cross07.CEL	F1cross08.CEL	F1cross09.CEL	F1cross10.CEL	F1cross11.CEL	F1cross12.CEL	F1cross13.CEL	F1cross14.CEL	F1cross15.CEL	F1cross16.CEL	F1cross17.CEL	F1cross18.CEL	F1cross19.CEL	F1cross20.CEL	F1cross21.CEL	F1cross22.CEL	F1cross23.CEL	F1cross24.CEL	F1cross25.CEL	F1cross26.CEL	F1cross27.CEL	F1cross28.CEL	F1cross29.CEL	F1cross30.CEL	F1cross31.CEL	F1cross32.CEL	F1cross33.CEL	F1cross34.CEL	F1cross35.CEL	F1cross36.CEL	F1cross37.CEL	F1cross38.CEL	F1cross39.CEL	F1cross40.CEL	F1cross41.CEL	F1cross42.CEL	F1cross43.CEL	F1cross44.CEL	F1cross45.CEL	F1cross46.CEL	F1cross47.CEL	F1cross48.CEL	F1cross49.CEL	F1cross50.CEL
#JAX00000001    Delta	0.62968	-0.36327	-0.31251	-0.46869	-0.44827	0.29681	-0.43194	-1.38177	-0.46569	-0.20571	-0.43557	-0.13220	-0.77444	-1.08506	-1.38209	-1.42991	-1.30185	0.61471	-1.26003	-0.42407	-1.58485	-1.39323	-0.24340	-1.43331	-0.45427	-1.28970	-0.29304	-0.42968	-1.47645	-0.32608	-1.14568	-2.08683	0.50232	-1.84460	-0.23003	-1.53318	-1.44954	0.68408	-1.35142	-0.95279	-0.37421	0.25687	0.86092	-0.29282	-0.28608	-0.44636	-1.65492	-0.26807	-0.68163	-0.46090
#JAX00000001	Size	9.45143	9.35175	9.30588	9.53589	9.55775	9.73082	9.41779	9.29542	9.33308	9.75441	9.46450	9.54694	9.36264	9.33515	9.17207	9.35789	9.31344	9.61703	9.45044	9.53119	9.47607	9.52894	9.63963	9.38681	9.54002	9.29779	9.37192	9.63871	9.35382	9.44583	9.30062	9.20300	9.37597	9.22986	9.40138	9.51283	9.40647	9.47831	9.32440	9.40985	9.49135	9.10820	9.48100	9.52789	9.42358	9.50864	9.47227	9.53101	9.50171	9.46944
#JAX00000002	Delta	2.00874	-0.57808	-0.42611	2.00840	-0.53843	1.74119	-0.16523	-0.35399	1.70600	-0.32491	1.74399	1.59861	2.04538	-0.52830	-0.22920	-2.15328	-2.19991	1.43278	-0.52593	-0.34913	-2.04456	-2.13190	-0.17320	-1.93641	-0.21044	-2.25523	-0.21382	-0.54281	-2.05697	-0.48752	-2.33728	-2.18831	2.02468	-2.17335	-0.80186	-2.12228	-1.89499	2.18991	-0.30073	-2.36889	1.90603	1.91968	2.06986	-0.38698	-0.21746	-0.26152	-2.39242	-0.32688	-0.27218	2.39882

#
##minimal file for normalized values
##%guid=0a5b6260-4832-4047-a59d-915a7fea7aa7
#probeset_id	datatype	F1cross01.CEL	F1cross02.CEL	F1cross03.CEL	F1cross04.CEL	F1cross05.CEL	F1cross06.CEL	F1cross07.CEL	F1cross08.CELF1cross09.CEL	F1cross10.CEL	F1cross11.CEL	F1cross12.CEL	F1cross13.CEL	F1cross14.CEL	F1cross15.CEL	F1cross16.CEL	F1cross17.CEL	F1cross18.CELF1cross19.CEL	F1cross20.CEL	F1cross21.CEL	F1cross22.CEL	F1cross23.CEL	F1cross24.CEL	F1cross25.CEL	F1cross26.CEL	F1cross27.CEL	F1cross28.CELF1cross29.CEL	F1cross30.CEL	F1cross31.CEL	F1cross32.CEL	F1cross33.CEL	F1cross34.CEL	F1cross35.CEL	F1cross36.CEL	F1cross37.CEL	F1cross38.CELF1cross39.CEL	F1cross40.CEL	F1cross41.CEL	F1cross42.CEL	F1cross43.CEL	F1cross44.CEL	F1cross45.CEL	F1cross46.CEL	F1cross47.CEL	F1cross48.CELF1cross49.CEL	F1cross50.CEL	B3_SNP10_198.CEL
#JAX00000001	Delta	0.36879	-0.23928	-0.20844	-0.28751	-0.27207	0.18108	-0.26418	-0.64198	-0.29435	-0.14152	-0.26673	-0.07981	-0.44022	-0.55029	-0.64413	-0.65507	-0.62185	0.36042	-0.60434	-0.27045	-0.68816	-0.64195	-0.16574	-0.65132	-0.27822	-0.61876	-0.19677	-0.26600	-0.66274	-0.20498	-0.57195	-0.78057	0.30868	-0.73994	-0.15672	-0.67985	-0.65556	0.39169	-0.62953	-0.50518	-0.23186	0.15990	0.47503	-0.19236	-0.17949	-0.27051	-0.70316	-0.16627	-0.39900	-0.29136	-0.17727
#JAX00000001	Size	10.48189	10.35950	10.31143	10.55923	10.57499	10.73312	10.43515	10.44800	10.34630	10.75130	10.48169	10.54903	10.40638	10.43510	10.33044	10.52457	10.45162	10.64026	10.58370	10.54179	10.68697	10.69479	10.63976	10.55853	10.55972	10.43316	10.37640	10.65899	10.53473	10.45852	10.41531	10.55128	10.40269	10.50659	10.39961	10.70293	10.58166	10.51061	10.47722	10.48847	10.50638	10.10581	10.54858	10.53170	10.43309	10.52616	10.70116	10.53752	10.53409	10.48178	10.58262
#JAX00000002	Delta	0.76870	-0.34509	-0.26697	0.76702	-0.33105	0.72450	-0.09919	-0.22557	0.71465	-0.20560	0.72321	0.69389	0.77487	-0.30798	-0.15782	-0.78996	-0.79669	0.65196	-0.31687	-0.22601	-0.77604	-0.78751	-0.10344	-0.75718	-0.13239	-0.80673	-0.14545	-0.32451	-0.77442	-0.29790	-0.81835	-0.79573	0.77288	-0.79535	-0.44184	-0.78743	-0.74947	0.79666	-0.19882	-0.82193	0.75364	0.75394	0.78004	-0.24260	-0.14281	-0.15794	-0.82347	-0.20125	-0.16836	0.82365	0.81537
#JAX00000002	Size	10.72669	10.82450	10.79594	10.94793	11.09031	10.79966	10.92728	11.02330	10.63781	11.09540	10.59431	10.50970	10.66843	10.79992	10.84225	10.97369	11.11111	10.60618	10.62469	10.96169	11.29049	10.92832	11.11334	10.92777	11.01000	11.13215	11.00321	10.84327	10.84141	10.97480	10.97385	10.94706	10.79471	10.94064	10.77233	11.10921	11.07843	10.61608	10.77417	11.06139	10.54568	10.50254	10.67811	10.94948	11.14039	10.86282	11.07376	10.98936	10.89404	10.75453	11.21583
#JAX00000003	Delta	0.59326	0.69194	0.72719	0.70209	0.71671	0.24283	0.69516	-0.00690	0.72303	-0.03581	0.65427	0.64388	0.68785	-0.16346	-0.08200	-0.09173	0.01678	0.58352	-0.01547	-0.02373	0.10677	0.00651	0.73258	0.14915	0.67909	0.03689	0.79479	-0.35245	-0.13793	0.74528	-0.02407	-0.17078	0.64206	0.15833	-0.32187	0.19023	0.08090	0.56064	-0.06325	-0.08072	0.65010	0.52759	0.58967	0.69521	-0.15531	0.52849	0.08449	0.66291	0.11168	0.69129	0.80627
#JAX00000003	Size	10.00955	10.49661	10.48934	10.48627	10.50584	9.88628	10.42969	10.43850	10.42727	10.46874	10.57266	10.17191	10.42930	10.27835	10.48233	10.29574	10.36991	10.20743	10.12128	10.41028	10.51127	10.38496	10.24890	10.21112	10.37270	10.38782	10.59198	10.44039	10.14410	10.69741	9.95656	10.15859	10.46660	10.25494	10.04567	10.37430	10.75189	10.10759	10.16456	9.80981	10.30988	10.28187	10.40066	10.51798	10.00965	10.36042	10.52729	10.37750	10.38264	10.29572	10.97627
#JAX00000004	Delta	0.44972	-0.01878	0.01602	-0.01340	-0.10566	0.49467	0.01301	-0.68411	-0.18885	-0.11056	-0.12576	-0.08972	-0.00911	-0.73159	-0.69354	-0.61921	-0.69680	0.62030	-0.65002	-0.08194	-0.69641	-0.54770	-0.03536	-0.64388	0.00862	-0.67620	-0.02748	-0.18434	-0.66772	-0.11126	-0.58402	-0.70929	0.61651	-0.61427	-0.21097	-0.67542	-0.68155	0.59276	-0.64635	-0.48346	-0.16943	0.59124	0.62208	-0.17092	-0.11368	-0.03461	-0.57231	0.04015	-0.14307	-0.16436	-0.05918

#TODO: make these user defined
my $refCelPath = "/home/wilsonte/mdg/cel/F1";
my $testCelPath = "/home/wilsonte/mdg/cel/test";
my $arrayDefPath = "/home/wilsonte/mdg/def";
my $aptPath = "/home/wilsonte/lib/apt/bin";

sub processAffy{
    my ($sample) = @_;
    my $testCelFile = "$testCelPath/$sample.CEL";
    my $celsFile = generateCelsFile($testCelFile);
    my $outputPath = runAptProbesetGenotype($celsFile, $sample);
}

sub generateCelsFile{
    my ($testCelFile) = @_;
    status("generating cels file...\n");
    my $celsFile = "$testCelFile.cels.txt";
    open my $celsFileH, ">", $celsFile or die "could not open $celsFile";
    print $celsFileH "cel_files\n";
    foreach my $celFile(<$refCelPath/*.CEL>){ 
        print $celsFileH "$celFile\n"; 
    }
    print $celsFileH "$testCelFile\n";
    close $celsFileH;
    return $celsFile;
}

sub runAptProbesetGenotype{
    my ($celsFile, $sample) = @_;
    status("running apt-probeset-genotype...\n");
    my $outputPath = "$testCelPath/$sample";
    my $cdfFile = getCDFFile();
    my $aptCommand = "$aptPath/apt-probeset-genotype ";   
    $aptCommand .= "-o $outputPath ";
    
    $aptCommand .= "--a quant-norm.sketch=50000,pm-only,brlmm-p.CM=1.bins=100.mix=1.bic=2.HARD=3.SB=0.75.KX=0.2.KH=0.3.KXX=-0.1.KAH=-0.1.KHB=-0.1.transform=MVA.AAM=2.0.BBM=-2.0.AAV=0.06.BBV=0.06.ABV=0.06.copyqc=0.00000.wobble=0.05.CSepThr=4.CSepPen=0.1.KYAH=-0.05.KYHB=-0.05.KYAB=-0.1.AAY=9.ABY=9.5.BBY=9.copytype=-1.clustertype=2.ocean=0.00001.MS=0.1 ";
#    $aptCommand .= "--a quant-norm.sketch=50000,pm-only,brlmm-p ";
    
    $aptCommand .= "--summaries ";
    $aptCommand .= "--write-models ";   
    $aptCommand .= "--cel-files $celsFile ";
    $aptCommand .= "-c $cdfFile "; 
    $aptCommand .= "-s $arrayDefPath/SNPsubset.txt ";    
    $aptCommand .= "--read-models-brlmmp $arrayDefPath/models ";
    $aptCommand .= "--chrX-probes $arrayDefPath/chrXprobes ";
    $aptCommand .= "--chrY-probes $arrayDefPath/chrYprobes ";
    $aptCommand .= "--special-snps $arrayDefPath/specialSNPs ";
    system($aptCommand);
    return $outputPath; 
}

sub getCDFFile {
    my @cdfFiles;
    foreach my $cdfFile(<$arrayDefPath/*.CDF>){
        push @cdfFiles, $cdfFile;
    }
    scalar @cdfFiles == 0 and die "could not find CDF file";
    scalar @cdfFiles > 1 and die "found more than one CDF file in  $arrayDefPath";
    return $cdfFiles[0];        
}

1;

